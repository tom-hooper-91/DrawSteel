name: Build and deploy a container app

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'infra/**'
      - '.github/**'
      - 'docker-compose.yml'
      - 'psakefile.ps1'
      - 'README.md'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    name: Build, Test and Push Image to Docker Hub
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install dependencies
        run: dotnet restore ./src

      - name: Build
        run: dotnet build ./src --no-restore

      - name: Run Tests
        run: dotnet test ./src --no-build
        
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: src
          file: src/API/Dockerfile
          push: true
          tags: thooper91/draw-steel-api:latest

  deploy:
    name: Deploy Container App
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    needs: build

    steps:
        - name: Check out code
          uses: actions/checkout@v6

        - name: Login to Azure
          uses: azure/login@v2
          with:
            client-id: ${{ secrets.AZURE_CLIENT_ID }}
            tenant-id: ${{ secrets.AZURE_TENANT_ID }}
            subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
   
        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ vars.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}

        - name: Get current revision (for rollback)
          id: get-revision
          run: |
            CURRENT_REVISION=$(az containerapp revision list \
              --name ${{ vars.CONTAINER_APP_NAME }} \
              --resource-group ${{ vars.RESOURCE_GROUP_NAME }} \
              --query "[?properties.active && properties.trafficWeight > \`0\`].name | [0]" -o tsv)
            echo "current_revision=$CURRENT_REVISION" >> $GITHUB_OUTPUT
            echo "Current active revision: $CURRENT_REVISION"

        - name: Deploy Container App
          id: deploy
          uses: azure/container-apps-deploy-action@v2
          with:
            appSourcePath: ${{ github.workspace }}/src
            registryUrl: registry.hub.docker.com
            registryUsername: ${{ vars.DOCKERHUB_USERNAME }}
            registryPassword: ${{ secrets.DOCKERHUB_TOKEN }}
            containerAppName: ${{ vars.CONTAINER_APP_NAME }}
            containerAppEnvironment: ${{ vars.CONTAINER_ENV_NAME }}
            resourceGroup: ${{ vars.RESOURCE_GROUP_NAME }}
            imageToBuild: thooper91/draw-steel-api:${{ github.sha }}
            dockerfilePath: API/Dockerfile

        - name: Wait for revision to be ready
          id: wait-ready
          run: |
            echo "Waiting for new revision to become ready..."
            MAX_ATTEMPTS=30
            ATTEMPT=0
            
            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              REVISION_STATUS=$(az containerapp revision list \
                --name ${{ vars.CONTAINER_APP_NAME }} \
                --resource-group ${{ vars.RESOURCE_GROUP_NAME }} \
                --query "[0].properties.runningState" -o tsv)
              
              echo "Attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS: Revision status is '$REVISION_STATUS'"
              
              if [ "$REVISION_STATUS" == "Running" ]; then
                echo "Revision is running successfully!"
                echo "status=success" >> $GITHUB_OUTPUT
                exit 0
              elif [ "$REVISION_STATUS" == "Failed" ] || [ "$REVISION_STATUS" == "Degraded" ]; then
                echo "Revision failed to start with status: $REVISION_STATUS"
                echo "status=failed" >> $GITHUB_OUTPUT
                exit 1
              fi
              
              ATTEMPT=$((ATTEMPT + 1))
              sleep 10
            done
            
            echo "Timeout waiting for revision to be ready"
            echo "status=timeout" >> $GITHUB_OUTPUT
            exit 1

        - name: Rollback on failure
          if: failure() && steps.get-revision.outputs.current_revision != ''
          run: |
            echo "Deployment failed, rolling back to previous revision: ${{ steps.get-revision.outputs.current_revision }}"
            
            # Get the failed revision name
            FAILED_REVISION=$(az containerapp revision list \
              --name ${{ vars.CONTAINER_APP_NAME }} \
              --resource-group ${{ vars.RESOURCE_GROUP_NAME }} \
              --query "[0].name" -o tsv)
            
            # Deactivate the failed revision
            if [ -n "$FAILED_REVISION" ] && [ "$FAILED_REVISION" != "${{ steps.get-revision.outputs.current_revision }}" ]; then
              echo "Deactivating failed revision: $FAILED_REVISION"
              az containerapp revision deactivate \
                --name ${{ vars.CONTAINER_APP_NAME }} \
                --resource-group ${{ vars.RESOURCE_GROUP_NAME }} \
                --revision "$FAILED_REVISION" || true
            fi
            
            # Activate the previous revision
            echo "Activating previous revision: ${{ steps.get-revision.outputs.current_revision }}"
            az containerapp revision activate \
              --name ${{ vars.CONTAINER_APP_NAME }} \
              --resource-group ${{ vars.RESOURCE_GROUP_NAME }} \
              --revision "${{ steps.get-revision.outputs.current_revision }}"
            
            # Route all traffic to the previous revision
            az containerapp ingress traffic set \
              --name ${{ vars.CONTAINER_APP_NAME }} \
              --resource-group ${{ vars.RESOURCE_GROUP_NAME }} \
              --revision-weight "${{ steps.get-revision.outputs.current_revision }}=100"
            
            echo "Rollback completed successfully"
            exit 1
